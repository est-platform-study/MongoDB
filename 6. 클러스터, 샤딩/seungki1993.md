## 샤딩

- 대규모의 데이터를 작고 관리하기 쉬운 조각으로 분할하는 과정
- 데이터베이스를 둘이상의 서버로 분산하는 방법
- 샤딩의 목적은 저장소 분산과 부하분산



#### 저장소 분산

- Mongodb는  호스트 머신에 --dbpath 옵션으로 지정된 디렉토리에 저장
- 용량은 한정이 되어있기 때문에 더 이상 데이터를 추가할 수 없는 경우 샤딩이 최선의 방법일 수 있다.



#### 부하분산

- 기본적으로 인덱스와 데이터 세트를 램에 유지하는것이 중요하다. 램에 없다면 디스크로 부터 I/O작업이 발생하고 이는 성능저하에 큰 영향이 된다.
- 애플리케이션의 데이터가 늘어나게 되면 한정되어 있는 Ram에 데이터 세트는 들어갈 수 없으며 I/O 작업이 빈번하게 발생
- 이러한 점을 위해 샤딩의 가장 큰 이유다
- 샤딩을 결정하는 요소는 네트워크 사용 , 디스크 사용 , 램사용



#

### 샤드 클러스터



#### 구성요소

- 샤드
  - 애플리케이션 데이터를 저장
  - mongos라우터 또는 시스템 관리자만 샤드에 직접 연결해야한다.
  - 샤드는 단일 mongod서버가 될 수 있지만 운영환경에서는 복제세트로 배포해야한다.
  - 복제세트 
    - 마스터 슬레이브와 유사
    - 복제세트는 하나의 프라이머리  + 하나 또는 그 이상의 세컨더리가 존재
- mongos 라우터
  - 메타데이터를 캐시하고 샤드에 작업을 라우팅 하거나 샤딩
  - mongos서버는 애플리케이션과 같은 서버에 설치한다
  - mongos는 프로세스를 시작할 때마다 설정 서버로부터 메타데이터 복사본을 가지고 온다.
- 설정 서버
  - 메타데이터를 영구적으로 저장
  - 메타데이터는 클러스터의 설정사항과 각데이터 베이스 컬렉션 , 데이터 위치 , 샤드간의 데이터의 전송내역을 가지고 있는 로그
  - 실제 배포 서비스에서는 3개의 configserver을 구성해야한다.(deprecated sccc)
    - 3.2부터 복제세트로 배포 할 수 있다.(CSRS)
  - 설정서버가 있는 머신에 오류가 생기면 분할과 마이그레이션은 작동하지 않는다.

![20190823_093950](.\20190823_093950.png)

### MongoDB 데이터 단위

- 샤딩과 밀접한 관련이 있다.

#### document

- MongoDB에서 가장 작은 데이터 단위로 단일객체를 나타내며 더이상 분할 할 수없다.

#### 청크

- 샤드 설정에만 존재하는 개념
- 필드의 값별로 클러스터된 도큐먼트 그룹
- 샤드키라는 필드 또는 필드 집합에 대한 값을 기반으로 하는 논리적 그룹
- 최대 청크 크기 64MB

#### 컬렉션

- document들의 집합

#### 데이터베이스



#

### 데이터 분산방법

- 데이터 베이스 수준에서 데이터베이스가 모든 컬렉션과 함께 샤드에 위치
  - 어플리케이션이 직접 수동으로 분할해야한다.
  - 해당 방식은 권하지 않는다.
- 청크 수준에서 컬렉션의 도큐먼트 자체가 분할되어 샤드키에 따라 여러 샤드에 분산
  - 개별 컬랙션의 파티셔닝
  - 어플리케이션이 아니라 Mongodb 자체가 auto sharding
  - 청크의 개념을 사용한다.
  - document의 field값을 샤드키로 선택 
  - Mongodb는 해당 정보를 사용하여 document가 어떤 청크에 속하는지 확인
    - 확인하는 방식은 범위 기반이다.



#### MongoDB 분할 마이그레이션

##### 분할

- 청크가 최대 크기를 벗어나면 두 개의 청크로 분할 된다.



##### 마이그레이션

- 샤드사이에서 청크를 이동하는 과정
- 마이그레이션 라운드
  - 클러스터가 균등해질 때까지 청크가 많은 샤드에서 청크가 적은 샤드로 이동



#### 쿼리 라우팅

- 설정 서버는 샤드에 매핑된 키의 범위를 가지고 있다.
- 만약 쿼리 셀렉터에 샤드키값이 없다면 모든 샤드를 방문해서 결과를 가져온다(글로벌 쿼리)
- 샤드키가 있다면 샤드키가 포함된 샤드에서만 질의를해서 결과를 반환(target 쿼리)



#### 샤드에서 인덱스 중요성

- 샤드는 자신만의 인덱스를 가지기 때문에 각 샤드에 있는 동일한 컬랙션들에는 동일한 인덱스가 있어야 한다.
- 샤드 컬랙션에는 _id , 샤드키에 대해서만 고유 인덱스를 허용하면 다른 인덱스에는 고유 인덱스는 안된다.
- 컬랙션을 샤드 하기전에 선택할 샤드키에 대해 인덱스를 생성해야한다.



#### 샤드키 선택의 중요성

- 샤드키를 생성하면 절대 변경이 불가능하다.
- 잘못된 샤드키 선택은 성능저하를 가져온다.
  - 모든 쓰기 작업이 하나의 샤드로 몰리게 될 가능성이 있다
  - 즉 모든 읽기작업이 하나의 샤드에서 일어나게 된다는 소리고 이는 샤드를 사용하는 이유가 없다.
- 너무 낮은 수준으로 샤드키를 설정하지 마라
  - 예를 들어 이름으로 샤드키를 설정했다하자
  - 동일한 이름으로 데이트를 넣었는데 청크사이즈를 초과하면 청크는 다시이를 분할한다.
  - 하지만 분할 하고자하는 샤드키는 더이상 세분화 할 수 없다.
  
#### 샤드
-   삭제 가능하다.
-   컬랙션을 샤드 안으로 부터 삭제하는 방법은 공식적으로 지원하지 않기 때문에 다른 컬랙션에 백업을 하고 삭제한다.
-   샤드 클러스터 백업
    -   청크 마이그레이션 비활성화
        -   샤드 백업중 마이그레이션이 발생할 수 있으며 데이터 누락현상이 발생한다.
    -   설정 서버 메타데이터
    
    